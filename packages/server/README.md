# zzz-data-server

Cloudflare Worker API that exposes the `zzz-data` package over REST with autogenerated OpenAPI docs. Built with Hono, hardened with CORS/CSRF middleware, and deployed through Wrangler.

## Features

- **REST + OpenAPI** – `/api/*` endpoints backed by `@hono/zod-openapi` schemas and `/docs` Swagger UI.
- **Consistent payloads** – Unified `{ success, data, error }` envelope via the helper utilities in `src/utils`.
- **Type-safe data** – Consumes the workspace version of `zzz-data`, so new datasets are instantly available after rebuilding the package.

## Prerequisites

- Node.js 20+
- pnpm 10+
- Cloudflare account with Wrangler configured (`wrangler login`)

Install dependencies from the repo root (`pnpm install`) so the workspace links resolve before running any commands below.

## Local Development

```bash
pnpm run data:build    # ensure the data package is up to date
pnpm run server:dev    # start wrangler dev with live reloading
```

### Available Endpoints

| Method | Path                   | Description                                              |
| ------ | ---------------------- | -------------------------------------------------------- |
| `GET`  | `/`                    | Health check returning `{ message: "Hello!" }`.          |
| `GET`  | `/docs`                | Swagger UI rendered from the generated OpenAPI document. |
| `GET`  | `/openapi.json`        | Raw OpenAPI 3.1 specification.                           |
| `GET`  | `/api/agents`          | List of all agents.                                      |
| `GET`  | `/api/anomalies`       | List of anomaly types and associated data.               |
| `GET`  | `/api/bangboos`        | List of Bangboos.                                        |
| `GET`  | `/api/deadly-assaults` | Deadly Assault stages and enemy metadata.                |
| `GET`  | `/api/drive-discs`     | Drive Disc sets.                                         |
| `GET`  | `/api/w-engines`       | W-Engine catalog.                                        |

### Response Contract

Successful responses follow the shared schema defined in `src/schemas/responses.ts`:

```json
{
  "success": true,
  "data": {
    "agents": [
      /* ... */
    ]
  },
  "error": null
}
```

Errors mirror this shape with `success: false` and a string `error` message.

## Deployment

```bash
pnpm run server:deploy
```

The command wraps `wrangler deploy --minify` and uses the configuration in `wrangler.jsonc` (entry point `src/index.ts`, route `zzz.ayingott.me`). Ensure the target zone and bindings are already set up in Cloudflare before deploying.

## Adding New Endpoints

1. Define the Zod schema in `src/schemas` (or extend an existing one).
2. Create the route in `src/apis/<resource>.ts` and export it from `src/apis/index.ts`.
3. Update `src/index.ts` if additional middleware or routing is required.
4. Run `pnpm run server:dev` to validate the OpenAPI document and test the route locally.

## Troubleshooting

- Wrangler caches compiled output; restart the dev server if the schema or TypeScript types change.
- If Puppeteer cannot run during `pnpm run data:scrape`, install the required system dependencies or pass `PUPPETEER_EXECUTABLE_PATH` to target an existing Chrome.
